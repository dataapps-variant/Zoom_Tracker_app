================================================================================
ZOOM BREAKOUT ROOM TRACKER - DEVELOPMENT CHANGELOG
================================================================================
This file documents all changes made during development sessions.
Last Updated: 2026-02-19

================================================================================
SESSION: 2026-02-19 - CAMERA TRACKING & QOS PAGINATION FIX
================================================================================

MAIN FOCUS: Camera ON/OFF tracking for participants

ISSUES FIXED:

1. QOS PAGINATION - Only 30 records returned
   CAUSE: Zoom API default page size is 30, no pagination implemented
   FIX: Added pagination loop with next_page_token in get_past_meeting_participants()
   RESULT: Now collects 1800+ participants instead of 30

2. CAMERA DATA NOT AVAILABLE VIA WEBHOOKS
   DISCOVERY: Zoom does NOT provide meeting.participant_video_started/stopped webhooks
   SOLUTION: Use Dashboard QoS API (/metrics/meetings/{id}/participants/qos)
   - Camera ON detected when video_output has bitrate/resolution
   - Camera OFF when video_output is empty/null
   LIMITATION: Only works for live meetings or within ~30 min of meeting end

3. QOS API PAGINATION - Only 500 participants
   CAUSE: max_pages was 50, page_size is 10 (Zoom QoS API limit)
   FIX: Increased max_pages from 50 to 200 (now handles 2000 participants)

4. REPORT CSV COLUMNS MISMATCH
   CAUSE: CSV header had Camera_On_IST/Camera_Off_IST but query returns Camera_On_Intervals
   FIX: Updated report_generator.py to match query output

5. SEARCH FEATURE FOR CAMERA DATA
   ADDED: POST /test/camera-qos with {"meeting_id": "xxx", "search": "name"}
   - Returns all matching participants instead of truncated 20

CHANGES MADE:

1. app.py - QoS & Camera Tracking
   - get_past_meeting_participants(): Added pagination with next_page_token
   - get_meeting_participants_qos(): New method for Dashboard QoS API with camera detection
   - _collect_previous_meeting_qos(): Collects camera data + QoS when new meeting starts
   - /test/camera-qos: Added search parameter for finding specific participants
   - /qos/scheduled: Added auto-cleanup of data older than 2 days
   - max_pages increased from 50 to 200 (2000 participants max)

2. report_generator.py - Daily Report
   - Fixed CSV header: Name, Email, Main_Joined_IST, Main_Left_IST, Total_Duration_Min,
     QoS_Duration_Min, Camera_On_Intervals, Room_History
   - Fixed data rows to match new columns
   - Updated email HTML table to include Camera ON column

3. BigQuery qos_data table
   - Added column: camera_on_count INTEGER

CLOUD SCHEDULER JOBS:
   - daily-qos-collection: 9:30 AM IST (4:00 UTC) -> /qos/scheduled
   - daily-attendance-report: 11:15 AM IST (5:45 UTC) -> /report/generate

AUTO-CLEANUP:
   - QoS data older than 2 days automatically deleted during scheduled collection
   - Prevents quota issues and keeps data fresh

DEPLOYMENTS:
   - Revision 38: Initial camera QoS collection
   - Revision 39: Search feature added, CSV fix
   - Revision 40: QoS pagination increased to 2000
   - Revision 41: Auto-cleanup of old data (>2 days)

TESTING SHASHANK'S CAMERA STATUS:
   Command: curl -X POST "https://breakout-room-calibrator-1041741270489.us-central1.run.app/test/camera-qos" \
            -H "Content-Type: application/json" \
            -d '{"meeting_id": "9034027764", "search": "shashank"}'

   Result: 4 sessions found, Camera ON in 2 intervals (at 08:28 and 09:54 UTC)

KEY LEARNINGS:

1. ZOOM CAMERA WEBHOOKS DON'T EXIST
   - No meeting.participant_video_started/stopped events
   - Must use Dashboard QoS API for camera status
   - Requires Business/Education/Enterprise plan
   - Requires dashboard_meetings:read:admin scope

2. QOS API LIMITATIONS
   - Max 10 participants per page (Zoom limit)
   - Data only available for ~30 min after meeting ends
   - Must collect immediately when meeting ends

3. SERVER-TO-SERVER OAUTH FOR QOS
   - Created new Server-to-Server OAuth app in Zoom Marketplace
   - Required scopes: meeting:read:admin, report:read:admin,
     dashboard:read:list_meeting_participants_qos:admin
   - Updated ZOOM_WEBHOOK_SECRET in GCP Secret Manager

USEFUL COMMANDS:

# Search participant camera status
curl -X POST "https://breakout-room-calibrator-1041741270489.us-central1.run.app/test/camera-qos" \
  -H "Content-Type: application/json" \
  -d '{"meeting_id": "MEETING_ID", "search": "participant_name"}'

# Generate report manually
curl -X POST "https://breakout-room-calibrator-1041741270489.us-central1.run.app/report/generate" \
  -H "Content-Type: application/json" \
  -d '{"date": "2026-02-19"}'

# Trigger QoS collection manually
curl -X POST "https://breakout-room-calibrator-1041741270489.us-central1.run.app/qos/scheduled" \
  -H "Content-Type: application/json" \
  -d '{"date": "2026-02-19"}'

# Check QoS data in BigQuery
bq query --use_legacy_sql=false "
SELECT participant_name, camera_on_count, duration_minutes
FROM \`variant-finance-data-project.breakout_room_calibrator.qos_data\`
WHERE event_date = CURRENT_DATE()
LIMIT 20"

================================================================================
SESSION: 2026-02-17 (Current)
================================================================================

ISSUE: Room names showing as "Room-XXXXXXXX" instead of actual names
CAUSE: Webhook UUIDs have different format than SDK UUIDs
       - SDK format: {E7F123FC-EE33-47D8-BC5E-C84FCD31E06F}
       - Webhook format: n0a1FJhALeimJ5UPLUTxiw== (base64-like)

SOLUTION: Capture webhook UUIDs during Scout Bot calibration

CHANGES MADE:

1. app.py - Added webhook UUID capture during calibration
   - Added `pending_room_moves` queue to MeetingState class
   - Added `calibration_in_progress` flag
   - Updated `handle_breakout_room_join()` to detect Scout Bot and map webhook UUID
   - Updated `/calibration/start` to initialize calibration tracking
   - Updated `/calibration/mapping` to track pending room moves
   - Updated `/calibration/complete` to report webhook matches

2. breakout-calibrator/src/components/CalibrationPanel.jsx
   - Fixed `handleSelfCalibration()` to notify backend before each move
   - Added calls to `notifyCalibrationStart()`, `sendRoomMapping()`, `notifyCalibrationComplete()`
   - Backend now knows which room Scout Bot is entering

3. breakout-calibrator/src/services/zoomService.js
   - Changed MOVE_DELAY_MS from 3000ms to 10000ms (10 seconds)
   - Gives Scout Bot time to click "Join" and enter room before next move

4. Created: attendance_report_with_room_names.sql
   - SQL query that joins webhook events with room mappings
   - Uses multiple matching strategies (exact UUID, short UUID, case-insensitive)

FILES DELETED (cleanup):
   - complete-deploy.zip
   - deploy-package.zip
   - update-deploy.zip
   - TOMORROW_STEPS.md
   - GCP_DEPLOYMENT_PLAN.md
   - GCP_SETUP_GUIDE.md
   - zoom_webhook_bigquery.py (replaced by app.py)
   - bigquery_setup.sql (duplicate of bigquery_schemas.sql)
   - check_uuids.sql (temporary debug)
   - debug_mappings.sql (temporary debug)
   - report_query.sql (replaced by attendance_report_with_room_names.sql)
   - quick-deploy.sh
   - deploy.sh
   - nul (empty file)

DEPLOYMENTS:
   - Revision 26: Initial webhook calibration fix
   - Revision 27: Fixed self-calibration to notify backend
   - Revision 28: Increased move delay to 10 seconds

================================================================================
SESSION: 2026-02-16
================================================================================

ISSUE: BigQuery data returning 0 for all queries
CAUSE: Multiple issues with data extraction and insertion

FIXES APPLIED:
1. Duration conversion - Zoom API returns seconds, was stored as minutes
2. Added extract_participant_data() with comprehensive fallbacks
3. Added validate_and_clean_event() before all BQ inserts
4. Full payload logging in webhook handler
5. Traceback logging on failures
6. Test endpoints: /test/webhook-insert, /test/qos-insert, /test/bigquery

================================================================================
SESSION: 2026-02-12
================================================================================

ISSUE: Calibration showed success but Scout Bot never moved
CAUSE: Wrong SDK parameter name

FIX: useZoomSdk.js - Changed `uuid` to `breakoutRoomUUID` in assignParticipantToBreakoutRoom()

LESSON LEARNED:
- SDK returns `breakoutRoomId`, NOT `breakoutRoomUUID`
- Use fallback chain for room UUID:
  const roomUUID = room.breakoutRoomId || room.breakoutRoomUUID || room.uuid

================================================================================
EARLIER SESSIONS
================================================================================

- Initial project setup with Flask server
- Zoom webhook integration
- BigQuery table creation
- React Zoom App (breakout-calibrator) creation
- Cloud Run deployment
- Zoom Marketplace app configuration

================================================================================
KEY LESSONS LEARNED
================================================================================

1. UUID FORMAT MISMATCH
   - SDK UUIDs: {GUID-FORMAT-WITH-BRACES}
   - Webhook UUIDs: base64-like string
   - Solution: Store both formats, use room NAMES as common key

2. SDK PARAMETER NAMES
   - assignParticipantToBreakoutRoom needs: participantUUID, breakoutRoomUUID
   - Room object has: breakoutRoomId (not breakoutRoomUUID!)
   - Participant object has: participantUUID

3. ZOOM SECURITY
   - Participants must click "Join" to enter breakout rooms
   - SDK cannot force participants into rooms
   - Calibration requires someone to click "Join" on each popup

4. TIMING
   - Room entry takes ~5 seconds after clicking "Join"
   - Need sufficient delay between moves (10 seconds works well)

================================================================================
USEFUL COMMANDS
================================================================================

# Deploy to Cloud Run
cd C:\Users\shash\Downloads\zoom+tracker
gcloud run deploy breakout-room-calibrator --source . --region us-central1 --allow-unauthenticated

# Build React app before deploy
cd breakout-calibrator && npm run build && cd ..

# Check logs
gcloud run services logs read breakout-room-calibrator --region us-central1 --limit 100

# Check BigQuery mappings
SELECT source, COUNT(*) FROM `variant-finance-data-project.breakout_room_calibrator.room_mappings` WHERE mapping_date = CURRENT_DATE() GROUP BY source;

# Test BigQuery connection
curl https://breakout-room-calibrator-1041741270489.us-central1.run.app/test/bigquery

================================================================================
CURRENT STATE (2026-02-17)
================================================================================

Cloud Run URL: https://breakout-room-calibrator-1041741270489.us-central1.run.app
GCP Project: variant-finance-data-project
BigQuery Dataset: breakout_room_calibrator

Tables:
- participant_events: 1988 records
- room_mappings: 331 records
- camera_events: 0 records
- qos_data: 4 records

Calibration Status:
- SDK mappings (zoom_sdk_app): Working
- Webhook mappings (webhook_calibration): Needs calibration with Scout Bot clicking "Join"

NEXT STEP FOR USER:
Run calibration with Scout Bot clicking "Join" on each room popup to capture webhook UUIDs.

================================================================================
